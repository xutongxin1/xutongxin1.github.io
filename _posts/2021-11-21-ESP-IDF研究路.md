---
layout: post
title: ESP-IDF研究路
categories: 日志
tags: 
    - 日志 
    - 大二
BGImage: 'https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img0/20220310123346.png'
jekyll-theme-WuK:
    musicid: '34367899'
---

### 环境：虚拟机Ubuntu20

框架：IDF

工具使用上，原来想用PlatformIO直接解决，但是发现每次整理编译链太慢



# 环境安装的方案

先按照github安装IDF框架（使用sh命令行）

然后安装vscode的插件，设置以下内容

```
${env:HOME}/esp/esp-idf
```

![image-20211126215922303](https://raw.githubusercontents.com/xutongxin1/PictureBed/master/img0/image-20211126215922303.png)

![image-20211126220012275](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img0/image-20211126220012275.png)

```
/home/xtx/.espressif/python_env/idf5.0_py3.8_env/bin/python
```

每一个python虚拟环境都有一个python.exe，可以先看看export.sh的设置然后which一下

![image-20211126220126340](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img0/image-20211126220126340.png)

```
${env:HOME}/esp/esp-idf/tools
```

[issuse](https://github.com/espressif/vscode-esp-idf-extension/issues/580)

# 初始化各种外设

## wifi

sta：站点模式，就是作为设备接入wifi

AP：接入点模式，就是自己开wifi

先是netIf框架(底层 TCP/IP 堆栈)

```c++
    ESP_ERROR_CHECK(esp_netif_init());

    ESP_ERROR_CHECK(esp_event_loop_create_default());
    esp_netif_create_default_wifi_sta();//初始化默认netif为sta模式
```

esp_event_loop_create_default参见事件循环库

简单描述就是打开一个循环处理接入wifi这些事件

这里创建默认循环（默认命名和处理频率而已），循环里面默认没有任何东西！！！

需要在后面的代码中再向循环中添加事件及其事件的处理方法



然后是初始化wifi外设（并没有指定是啥模式，就相当于打开时钟）

```c++
  wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
  ESP_ERROR_CHECK(esp_wifi_init(&cfg));
```



然后是上文提到的事件注册

```c++
    esp_event_handler_instance_t instance_any_id;
    esp_event_handler_instance_t instance_got_ip;
    ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT,
                                                        ESP_EVENT_ANY_ID,
                                                        &event_handler,
                                                        NULL,
                                                        &instance_any_id));
    ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT,
                                                        IP_EVENT_STA_GOT_IP,
                                                        &event_handler,
                                                        NULL,
                                                        &instance_got_ip));
```

[esp_event_handler_instance_register](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s2/api-reference/system/esp_event.html#_CPPv435esp_event_handler_instance_register16esp_event_base_t7int32_t19esp_event_handler_tPvP28esp_event_handler_instance_t)将事件处理程序的实例注册到默认循环

# 函数用法

## ESP相关

### ESP_ERROR_CHECK

如果不是ESP_OK自动重启

### ESP_LOGI

```cpp
ESP_LOGI(TAG, "ESP_WIFI_MODE_STA");
```

日志记录器，可以打印到串口，但很明显比printf优雅

![image-20211122224342495](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img0/image-20211122224342495.png)







